# OpenDTU and Shelly for photovoltaic systems - Integration into HomeAssistant

## Short way to use
What do you need to connect to your OpenDTU:
1. You need to install the REST integration (the base for connection to your opendtu using HTTP REST)
2. You need to download and copy the examples/opendtu.yml to your system
3. You need to edit the line with the ip address in your copy of the opendtu.yml
4. You need to link from your local configuration.yml to your copy of the opendtu.yml

As editor you could use one of the following add-ons (i am using both):
* File Editor
* Studio Code Server

After that you can create visualisations for the entites (which is not described here)

## Setup
I am currently using OpenDTU Version v23.6.28. Update is work in progress.

As it is now allowed in germany to use "plug-and-play" photovoltaic systems with limit of 800 Watt,
I decided to build this on my garage. The hardware I used is listed here: [HARDWARE.md](./docs/HARDWARE.md).

After installing the PV, I decided to integrate this into a new home automation system.
The possibilites I found, are described here: [INTEGRATION.md](./docs/INTEGRATION.md).

Last but not least I decided to use "Home Assistant".
Details are described here [HOMEASSISTANT.md](./docs/HOMEASSISTANT.md)

## Aim

The aim of this documentation is, to delivery the sources, and describe the decisions and some experience.

The content:
* In [src](./src) folder you could find working YAML files for integration into Home Assistant.
* In [examples](./examples) folder you could find json data generated by my devices (some data are anonymized)
* In [docs](./docs) folder you could find background informations

The implementation uses the REST API of the OpenDTU as described here: https://www.opendtu.solar/firmware/web_api/.

The following APIs are covered by the YAML file:
* http://192.168.178.15/api/eventlog/status?inv=112182216512
* http://192.168.178.15/api/limit/status
* http://192.168.178.15/api/livedata/status
* http://192.168.178.15/api/livedata/status?inv=112182216512
* http://192.168.178.15/api/mqtt/status
* http://192.168.178.15/api/network/status
* http://192.168.178.15/api/ntp/status
* http://192.168.178.15/api/power/status
* http://192.168.178.15/api/system/status

The following APIs are not covered by the YAML file:
* http://192.168.178.15/api/prometheus/metrics
* All APIs which require authentication (as I do not need them currently)
* All POST APIs.

The Integration of the OpenDTU is described here: 
* [Integration into HomeAssistant](./docs/HOMEASSISTANT.md)

## Usage
How to use my work?
1. You could read what I did, just for experience.
2. You could get the "opendtu.yaml" file and use it 
   1. Change the IP addresses inside the file to your addresses.
   2. Change the numbers of the inverters to your inverter numbers.
   3. If you have not exactly 3 inverters, you need to delete or copy some parts of the YAML files.
   4. If you have not exactly 1 string per inverter, you need to delete or copy some parts of the YAML files.
3. The configuration.yaml is only an example, you have your own.
   1. Add the last row. You need the "rest:" line.
   2. If the "rest:" line is in configuration.yaml, you do not need it in opendtu.yaml.
4. There are two versions:
   1. The opendtu.yaml contains the whole REST API for my OpenDTU, with all data. It is include by the "rest:" line in configuration.yaml. 
   2. The opendtu_small.yaml contains only the energy values, a minimum set of data.
5. Contact me in case of questions, I will try to answer. Please give me time for that.

## Links
This work is based on the following guides, which I could recommend and for which I thank a lot:
* Shelly
  * Shelly Parts and good video descriptions: https://shellyparts.de/
* Synology
  * Synology DS224+ RAM upgrade by Daniel Medic: https://www.youtube.com/watch?v=PdeafJfMXdw
* OpenDTU
  * OpenDTU: https://github.com/tbnobody/OpenDTU
  * OpenDTU Web API: https://www.opendtu.solar/firmware/web_api/
  * The OpenDTU Soldering Tutorial: https://binary-kitchen.github.io/SolderingTutorial/OpenDTU_Breakout/manual/OpenDTU_Breakout_de.pdf
  * Ready-to-use OpenDTU Hardware: https://shop.blinkyparts.com/de/OpenDTU-NRF-Deine-Auswertung-fuer-deine-Balkonsolaranlage-kompatibel-zu-Hoymiles-HM-Serie-NRF-Modul/blink237542
* Home Assistant
  * Tutorial by Simon42 https://www.simon42.com/home-assistant-template-sensoren-hilfsentitaten/#wechselrichter-anbinden-mit-restapi
  * Home Assistant Integration REST API: https://www.home-assistant.io/integrations/rest/
  * Home Assistant Device Classes: https://www.home-assistant.io/integrations/sensor#device-class
  * Debug Tool for JSON data: https://jsonpath.com/

# About me
My daily work is as an IT architect in different software projects, mainly programming with Java.
I do use different cloud solutions, most of the time kubernetes based. So ELK, Grafana, and so on is not new to me.
Home automation is new, and just a hobby.

I am living in germany, so the sources are sometimes in german language. Beg you pardon. :-)
