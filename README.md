# OpenDTU and Shelly for photovoltaic systems - Integration into HomeAssistant

## Short way to use
What do you need to connect to your OpenDTU:
1. You need to install the REST integration in HA (the base for connection to your opendtu using HTTP REST)
2. You need to download and copy the src/opendtu/*.yml files to your system (into a directory named opendtu)
3. You need to edit the lines with the ip address in the files
4. You need to edit the lines with the serial numbers in the files
5. You need to link from your local configuration.yml to include the files in the opendtu directory

For editing the files in HA, you could use one of the following add-ons (i am using both):
* File Editor
* Studio Code Server

After that you can create visualisations for the entities (which is not described here)

## Setup
I am currently using OpenDTU Version v25.2.3.

As it is now allowed in germany to use "plug-and-play" photovoltaic systems with limit of 800 Watt,
I decided to build this on my garage. The hardware I used is listed here: [HARDWARE.md](./docs/HARDWARE.md).

After installing the PV, I decided to integrate this into a new home automation system.
The possibilities I found, are described here: [INTEGRATION.md](./docs/INTEGRATION.md).

Last but not least I decided to use "Home Assistant".
Details are described here [HOMEASSISTANT.md](./docs/HOMEASSISTANT.md)

## Aim

The aim of this documentation is to delivery the sources, and describe the decisions and some experience.

The content:
* In [src](./src) folder you could find the configuration.yml to include the opendtu directory.
* In [src/opendtu](./src/opendtu) folder you could find working YAML files for integration into Home Assistant.
* In [src/dashboard](./src/dashboard) folder you could find working YAML files of my 2 dashboards with every entity.
* In [examples](./examples) folder you could find json data generated by my devices (some data are anonymized)
* In [docs](./docs) folder you could find background informations

The implementation uses the REST API of the OpenDTU as described here: https://www.opendtu.solar/firmware/web_api/.

The following APIs are covered by the YAML file:
* http://192.168.178.15/api/eventlog/status?inv=112182216512
* http://192.168.178.15/api/limit/status
* http://192.168.178.15/api/livedata/status
* http://192.168.178.15/api/livedata/status?inv=112182216512
* http://192.168.178.15/api/mqtt/status
* http://192.168.178.15/api/network/status
* http://192.168.178.15/api/ntp/status
* http://192.168.178.15/api/power/status
* http://192.168.178.15/api/system/status

The following APIs are not covered by the YAML file:
* http://192.168.178.15/api/prometheus/metrics
* All APIs which require authentication (as I do not need them currently)
* All POST APIs.

The Integration of the OpenDTU is described here: 
* [Integration into HomeAssistant](./docs/HOMEASSISTANT.md)

## Usage
How to use my work?
1. You could read what I did, just for experience.
2. You could copy the files from the "opendtu" directory to you HA. Then use it by doing the following steps: 
   1. Change the IP addresses inside the files to your ip address. 
      <br>Global replace all occurrences of "192.168.178.15" with your OpenDTU IP address.
   2. Change the serial numbers of the inverters in the files to your inverter numbers.
      <br>Global replace all occurrences of "112182216512" with your first inverter serial number.
      <br>Global replace all occurrences of "112182217151" with your second inverter serial number.
      <br>Global replace all occurrences of "112182217437" with your third inverter serial number.
   3. If you have not exactly 3 inverters, you need to delete or copy some parts of the YAML files.
   4. If you have not exactly 1 string per inverter, you need to delete or copy some parts of the YAML files.
3. The configuration.yaml is only an example, you have your own, adjust it:
   1. Add the row starting with "rest:", and change the directory name (opendtu) if necessary.
   2. If the "rest:" line is in configuration.yaml, you do not need to repeat it in the files.
4. Contact me in case of questions, I will try to answer. Please give me time for answering.

## Links
This work is based on the following guides, which I could recommend and for which I thank a lot:
* Shelly
  * Shelly Parts and good video descriptions: https://shellyparts.de/
* Synology
  * Synology DS224+ RAM upgrade by Daniel Medic: https://www.youtube.com/watch?v=PdeafJfMXdw
* OpenDTU
  * OpenDTU: https://github.com/tbnobody/OpenDTU
  * OpenDTU Web API: https://www.opendtu.solar/firmware/web_api/
  * The OpenDTU Soldering Tutorial: https://binary-kitchen.github.io/SolderingTutorial/OpenDTU_Breakout/manual/OpenDTU_Breakout_de.pdf
  * Ready-to-use OpenDTU Hardware: https://shop.blinkyparts.com/de/OpenDTU-NRF-Deine-Auswertung-fuer-deine-Balkonsolaranlage-kompatibel-zu-Hoymiles-HM-Serie-NRF-Modul/blink237542
* Home Assistant
  * Tutorial by Simon42 https://www.simon42.com/home-assistant-template-sensoren-hilfsentitaten/#wechselrichter-anbinden-mit-restapi
  * Home Assistant Integration REST API: https://www.home-assistant.io/integrations/rest/
  * Home Assistant Device Classes: https://www.home-assistant.io/integrations/sensor#device-class
  * Debug Tool for JSON data: https://jsonpath.com/

## Update notes
The following updates are done:
 * v25.2.3: From version v23.6.28 to v25.2.3 the OpenDTU API changed:
    * The AC/DC/INV values for the inverters are now requested per serial number.
    * There are some new values, but not much relevant.
    * The big opendtu.yml file has been splitted into smaller files, and the whole directory is now included.
    * The firmware image on the OpenDTU device needed to be upgraded, please see the update notes in OpenDTU.

# About me
My daily work is as an IT architect in different software projects, mainly programming with Java.
I do use different cloud solutions, most of the time kubernetes based. So ELK, Grafana, and so on is not new to me.
Home automation is new, and just a hobby.

I am living in germany, so the sources are sometimes in german language. Beg you pardon. :-)
